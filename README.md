# 相模原ダルク 電話対応支援システム

## 📋 プロジェクト概要

一般社団法人相模原ダルクの電話相談業務を効率化・標準化するための電話対応支援Webアプリケーションです。
電話対応マニュアルに基づいた段階的なガイド機能と、相談記録の管理・分析機能を提供します。

### 代表理事
**田中秀泰** - 薬物・アルコール・ギャンブル依存症者及びその家族への回復支援と社会復帰をサポート

### 🎨 PWAアイコン
**AI生成3D iOSスタイルアイコン完成**（2026年1月29日）
- モダンなiOS 17デザイン言語
- ブルー→シアンの美しいグラデーション背景
- 3D立体感のある白い電話受話器
- クリアなDARCテキスト（下部配置）
- プロフェッショナルなApp Store品質

## 🎯 主な機能

### ✅ 現在完成している機能（2026年1月27日 完全実装完了）

### 1. 新規相談受付システム 📞
- ✅ **6段階フェーズ管理**
  - 初期対応 → 情報収集 → 状況確認 → 提案・説明 → 次のステップ → 終了・フォローアップ
- ✅ **リアルタイム対応フレーズ選択**
  - カテゴリー別・フェーズ別のフレーズ集
  - ドロップダウンから選択してフェーズに追加
  - 使用したフレーズの自動記録
- ✅ **詳細な相談記録フォーム**
  - 基本情報（対応スタッフ、相談者氏名、電話番号、関係）
  - 対象者情報（氏名、年齢、性別）
  - 依存症の種類（11種類対応）
  - 緊急度評価（高・中・低）
- ✅ **バリデーション機能**
  - 必須項目のチェック
  - データ保存前の確認
  - エラーメッセージ表示
- ✅ **データベース自動保存**
  - Cloudflare D1への完全保存
  - フェーズ情報のJSON形式保存
  - 保存成功後のホーム画面への自動遷移

### 2. 相談履歴管理システム 🕐
- ✅ **一覧表示機能**
  - カード形式の見やすい表示
  - 相談日時・相談者名・緊急度・依存症種類
  - 対応スタッフ名の表示
  - ホバーアニメーション
- ✅ **高度な検索・フィルター機能**
  - 氏名による検索
  - 依存症種類によるフィルター
  - 緊急度によるフィルター
  - リアルタイム検索結果更新
- ✅ **ページネーション**
  - 20件ずつの表示
  - 前後ページ移動
  - 現在ページ/総ページ数の表示
- ✅ **詳細モーダル表示**
  - クリックで詳細情報を表示
  - 基本情報・対象者情報
  - 各フェーズの対応履歴
  - 使用したフレーズの記録
- ✅ **PDF出力機能**
  - 個別相談記録のPDF化（実装予定）

### 3. 統計情報ダッシュボード 📊
- ✅ **サマリーカード**
  - 総相談件数
  - 1日平均相談件数
  - グラデーションデザイン
- ✅ **期間選択機能**
  - 今週・今月・今年のボタン切り替え
  - 期間に応じたデータ表示
- ✅ **曜日別グラフ**
  - 横棒グラフで視覚化
  - パーセンテージベースの表示
  - アニメーション効果
- ✅ **依存症別分布グラフ**
  - 横棒グラフで視覚化
  - 上位5種類の表示
  - カラーコーディング
- ✅ **緊急度別分布グラフ**
  - 高・中・低の分布表示
  - 視覚的なバランス確認
- ✅ **CSV/PDFエクスポート**
  - データ一括出力（実装予定）
  - レポート生成（実装予定）

### 4. 対応マニュアル 📖
- ✅ **フレーズ検索機能**
  - キーワード検索
  - リアルタイム検索結果表示
- ✅ **カテゴリフィルター**
  - カテゴリ別の絞り込み
  - ボタンクリックで即座に切り替え
- ✅ **階層的表示**
  - カテゴリー → フェーズ → フレーズ
  - 3階層構造で整理
- ✅ **フレーズ詳細情報**
  - フレーズ本文
  - 使用シチュエーション
  - 視覚的なカード表示

### 5. ホーム画面 🏠
- ✅ **iOS風デザイン**
  - 濃い青のヘッダー（#1e40af）
  - 左側にタイトル、右上に電話番号

### 6. PWA（Progressive Web App）対応 📱
- ✅ **アプリインストール機能**
  - ホーム画面に追加可能
  - ネイティブアプリのような動作
  - iOS/Android/デスクトップ対応
- ✅ **オフライン対応**
  - Service Workerによるキャッシュ管理
  - インターネット接続なしでも基本機能が動作
  - 接続回復時の自動同期
- ✅ **モバイル最適化**
  - スマートフォン・タブレットで最適化された表示
  - タッチ操作に最適化されたUI
  - レスポンシブデザイン
- ✅ **セーフエリア対応**
  - iPhoneのノッチ対応
  - 画面端の安全領域を考慮
- ✅ **高速パフォーマンス**
  - Service Workerによる高速読み込み
  - スムーズなアニメーション
  - バッテリー消費の最適化
- ✅ **オンライン/オフライン検知**
  - 接続状態の自動検知
  - オフライン時の通知表示
  - 接続回復の自動通知
  - 4つの機能カード（白背景・角丸・影付き）
  - カラーアイコン（青・緑・紫・オレンジ）
- ✅ **本日の概要ボックス**
  - リアルタイム統計データ表示
  - 本日の相談・対応中・未完了・平均時間
  - 4分割の統計ボックス
  - 縦線で区切られたデザイン
- ✅ **レスポンシブ対応**
  - スマホ・タブレット・PC対応
  - 最大幅480pxで最適化

### 6. データベース管理 💾
- ✅ **Cloudflare D1 Database**
  - consultations（相談記録）テーブル
  - response_phrases（対応フレーズ）テーブル
  - staff（スタッフ）テーブル
- ✅ **マイグレーション完了**
  - 初期スキーマ作成済み
  - インデックス設定済み
- ✅ **初期データ投入**
  - スタッフ3名登録済み
  - 対応フレーズ4件登録済み

### 7. API機能 🔌
- ✅ **RESTful API**
  - GET /api/staff - スタッフ一覧取得
  - GET /api/phrases - 全フレーズ取得
  - GET /api/phrases/:category - カテゴリ別フレーズ取得
  - GET /api/consultations - 相談一覧取得（ページネーション）
  - GET /api/consultations/search - 検索機能
  - GET /api/consultations/:id - 詳細取得
  - POST /api/consultations - 新規登録
  - GET /api/stats/dashboard - 統計データ取得
- ✅ **エラーハンドリング**
  - 500エラー時の適切なエラーメッセージ
  - バリデーションエラーの通知
- ✅ **JSON形式のデータ交換**
  - 標準的なREST API設計
  - CORS対応

### 🚧 今後実装予定の機能

1. **認証・権限管理**
   - スタッフログイン機能
   - 役割別アクセス制御

2. **通知機能**
   - フォローアップのリマインダー
   - 緊急度「高」の通知
   - プッシュ通知（PWA拡張）

3. **レポート機能**
   - CSV/PDFエクスポート
   - 統計レポート自動生成
   - 印刷最適化

## 🌐 公開URL

### 本番環境（Cloudflare Pages）
- **本番URL**: https://sagamihara-darc.pages.dev
- **デプロイURL**: https://c18d3d98.sagamihara-darc.pages.dev
- **GitHub Repository**: https://github.com/hiderock84-sys/sagamihara-darc-philosophy
- **Cloudflare Dashboard**: https://dash.cloudflare.com/e696c49d9b07a09be98acdb426cb008e/workers-and-pages/overview

### 開発環境（Sandbox）
- **開発URL**: https://3000-iko5o0a9up8u6girs6d0a-2e77fc33.sandbox.novita.ai
- **API Base**: https://3000-iko5o0a9up8u6girs6d0a-2e77fc33.sandbox.novita.ai/api

## 📊 データアーキテクチャ

### データモデル

#### 1. 相談記録（consultations）
- 受付情報（日時、対応者）
- 基本情報（名前、年齢、性別、電話番号、相談者の関係）
- 依存症情報（種類、期間、頻度、重症度）
- 医療・治療歴（入院歴、通院歴、服薬状況、他施設利用）
- 緊急度評価（24時間以内使用、離脱症状、自傷他害、医療必要性、判定レベル）
- 相談内容・特記事項
- 次のアクション（面談予約、フォローアップ、連携先、報告）
- チェックリスト（6項目）

#### 2. 対応フレーズ（response_phrases）
- カテゴリー（opening, listening, information, closing, emergency）
- 段階（第1〜4段階）
- フレーズ種類（OK例、NG例、ルール、注意）
- フレーズ内容

#### 3. スタッフ（staff）
- 名前
- 役職（代表理事、上級スタッフ、スタッフ）
- 有効/無効フラグ

### ストレージサービス
- **Cloudflare D1（SQLite）**: 全データの永続化
- **ローカル開発**: `.wrangler/state/v3/d1`に自動作成されるSQLiteデータベース

### データフロー
1. フロントエンド（JavaScript）→ Hono API（TypeScript）
2. Hono API → Cloudflare D1 Database
3. データベース → API → フロントエンド

## 📱 依存症対応範囲

以下の依存症に対応しています：
- アルコール依存
- 薬物依存
- ギャンブル依存
- ゲーム依存
- ネット・スマホ依存
- 処方薬・市販薬依存
- 窃盗（クレプトマニア）
- 性依存
- 共依存
- 食行動の問題
- その他

## 👥 利用ガイド

### 新規相談を受ける場合

1. **ホーム画面**から「新規相談受付」をクリック
2. **左側の対応ガイド**を参考にしながら電話対応
3. **右側の記録シート**に情報を入力：
   - 受付情報（日時、対応者名）を入力
   - 相談者の基本情報を記録
   - 依存症の種類や状況を選択
   - 緊急度を評価（重要！）
   - 相談内容を詳細に記録
   - 次のアクション（面談予約など）を設定
4. **チェックリスト**を確認
5. 「相談記録を保存」ボタンをクリック

### 対応の4段階

#### 第1段階: オープニング（0-30秒）
- 名前を名乗り、相手の話を聞く姿勢を示す
- 例：「お電話ありがとうございます。相模原ダルクの〇〇と申します。本日はどのようなご相談でしょうか？」

#### 第2段階: 傾聴・共感（30秒-5分）
- 相手の話を遮らず、最後まで聞く
- 共感を示す言葉をかける
- 例：「そうだったんですね。それはとてもお辛い状況だったと思います。」

#### 第3段階: 情報提供（5-10分）
- 施設概要を説明（30秒スピーチ）
- 対応可能な依存症を伝える
- 面談予約の案内

#### 第4段階: クロージング
- 名前・連絡先の確認
- 緊急度の評価
- フォローアップ日の設定
- 例：「本日はお電話いただき、ありがとうございました。◯月◯日の◯時にお待ちしております。」

### 緊急対応が必要な場合

以下の場合は最優先対応：
- ✅ 24時間以内の使用がある
- ✅ 離脱症状がある
- ✅ 自傷・他害の恐れがある
- ✅ 医療機関への受診が必要

→ **緊急度「高」**を選択し、即日対応をスケジュール

## 🚀 デプロイ状況

### ローカル開発環境
- ✅ 開発環境構築完了
- ✅ データベースマイグレーション完了
- ✅ 初期データ投入完了
- ✅ テストデータ8件追加
- ✅ PM2によるサービス起動完了
- ✅ API動作確認完了
- ✅ 全機能実装完了

### 本番環境（Cloudflare Pages）
- ✅ **本番公開完了！**
- ✅ GitHub連携完了
- ✅ Cloudflare D1データベース作成完了
- ✅ 初期データ投入完了
- ✅ Cloudflare Pagesデプロイ完了
- ✅ 本番環境動作確認完了
- 🌐 **公開中**: https://sagamihara-darc.pages.dev

## 📊 実装済み機能の詳細

### 相談履歴管理
- **一覧表示**: 全相談記録をカード形式で表示
- **検索機能**: キーワード、緊急度、日付範囲で絞り込み
- **ページネーション**: 20件ずつの表示、前後ページ移動
- **詳細表示**: クリックで詳細情報を表示
- **エクスポート**: 各記録からPDF出力が可能

### 統計ダッシュボード
- **概要カード**: 4つの主要指標を大きく表示
- **緊急度別グラフ**: ドーナツチャートで視覚化
- **依存症種類別グラフ**: 横棒グラフで上位5件を表示
- **最近の相談**: 直近5件の相談をリスト表示
- **インタラクティブ**: Chart.jsによる動的グラフ

### エクスポート機能
- **CSV一括出力**: 全相談記録をCSV形式で出力
- **Excel対応**: BOM付きUTF-8でExcelで正しく開ける
- **PDF個別出力**: 各相談記録を印刷可能なPDF形式で出力
- **自動命名**: ファイル名に日付を自動付与

## 💻 技術スタック

### フロントエンド
- **HTML5 + JavaScript (ES6+)**
- **Tailwind CSS** (CDN) - レスポンシブデザイン
- **Font Awesome** - アイコン
- **Axios** - HTTP通信
- **SPA Architecture** - シングルページアプリケーション

### バックエンド
- **Hono Framework** - 高速軽量Webフレームワーク
- **TypeScript** - 型安全な開発
- **Cloudflare Workers** - エッジランタイム
- **Cloudflare Pages** - ホスティング

### データベース
- **Cloudflare D1** - SQLiteベースのグローバル分散データベース
- **Wrangler** - CLIツール

### 開発環境
- **Vite** - ビルドツール
- **PM2** - プロセスマネージャー
- **Git** - バージョン管理

## 📚 ドキュメント

- **[PWA_GUIDE.md](PWA_GUIDE.md)** - PWA機能の詳細ガイド
  - インストール方法（iOS/Android/デスクトップ）
  - オフライン機能の使い方
  - トラブルシューティング
  
- **[STAFF_MANAGEMENT.md](STAFF_MANAGEMENT.md)** - スタッフ管理マニュアル
  - スタッフの追加・管理方法
  - データベース操作
  - 本番環境への反映方法

- **[GitHub Repository](https://github.com/hiderock84-sys/sagamihara-darc-philosophy)** - ソースコードと全ドキュメント

## 📈 推奨される次のステップ

1. **PWAインストール** - スマートフォンのホーム画面に追加（[PWA_GUIDE.md](PWA_GUIDE.md)参照）
2. **認証機能の実装** - スタッフごとのログイン
3. **プッシュ通知の追加** - フォローアップリマインダー
4. **データバックアップ** - 定期的な自動バックアップ
5. **レポート機能の拡充** - CSV/PDFエクスポート
6. **アクセスログ機能** - 利用状況の追跡

## 🎨 使用技術の詳細

### グラフ・可視化
- **Chart.js 4.4.0** - 緊急度別・依存症種類別グラフの描画
  - ドーナツチャート（緊急度）
  - 横棒グラフ（依存症種類）
  - レスポンシブ対応

### データ処理
- **Axios** - HTTPリクエスト処理
- **JSON処理** - 複雑なデータ構造の管理
- **日付フォーマット** - 日本語ロケール対応

### UI/UX
- **Tailwind CSS** - レスポンシブデザイン
- **Font Awesome** - 豊富なアイコン
- **アニメーション** - フェードイン・ホバー効果

## 📝 データ構造

### 相談記録（consultations）テーブル
```sql
- id: 自動採番
- reception_datetime: 受付日時
- staff_name: 対応者名
- caller_*: 相談者情報（名前、年齢、性別、電話、関係）
- addiction_*: 依存症情報（種類、期間、頻度、重症度）
- hospitalization_*, outpatient_*: 医療・治療歴
- emergency_*: 緊急度評価（4項目のチェック + 判定）
- consultation_content: 相談内容
- notes: 特記事項
- interview_*, followup_*: 次のアクション
- check_*: 対応完了チェックリスト（6項目）
- created_at, updated_at: タイムスタンプ
```

### 現在のデータ状況
- **スタッフ**: 3名（田中秀泰代表理事、上級スタッフA、スタッフB）
- **対応フレーズ**: 約20件（4段階 + 緊急対応）
- **テスト相談記録**: 8件（様々な依存症パターン）

## 📞 お問い合わせ

**一般社団法人相模原ダルク**
- 代表理事: 田中秀泰
- 事業内容: 薬物・アルコール・ギャンブル依存症からの回復支援と社会復帰サポート
- 対象: 在日外国人、貧困家庭、機能不全家族、特に子どもたちへの包括的支援

## 📄 ライセンス

© 2026 一般社団法人相模原ダルク - All Rights Reserved

---

**最終更新日**: 2026年1月27日  
**開発状況**: ✅ **全機能実装完了！** | 🚀 本番運用可能

## 🎉 完成した機能一覧

### ✅ 実装完了（2026年1月27日）
- [x] **新規相談受付システム** - 6段階フェーズ管理、リアルタイムフレーズ選択
- [x] **相談履歴管理** - 一覧表示、検索、フィルター、詳細モーダル
- [x] **統計ダッシュボード** - 曜日別・依存症別・緊急度別グラフ可視化
- [x] **対応マニュアル** - フレーズ検索、カテゴリフィルター、階層表示
- [x] **iOS風デザイン** - 濃い青ヘッダー、カラーアイコン、統計ボックス
- [x] **RESTful API** - 8エンドポイント、完全なCRUD操作
- [x] **データベース管理** - Cloudflare D1、マイグレーション、初期データ
- [x] **レスポンシブデザイン** - スマホ・タブレット・PC完全対応
- [x] **エラーハンドリング** - トースト通知、バリデーション

### 🚧 今後の拡張予定
- [ ] **PDF/CSVエクスポート** - データ一括出力、レポート生成
- [ ] **認証・権限管理** - スタッフログイン、アクセス制御
- [ ] **通知機能** - フォローアップリマインダー、緊急通知
- [ ] **データバックアップ** - 自動バックアップ、復元機能
- [ ] **PWA化** - オフライン対応、プッシュ通知
- [ ] **高度な分析** - トレンド分析、予測機能

---

## 🎊 完全実装完了のお知らせ

**2026年1月27日、相模原ダルク電話対応支援システムの全コア機能の実装が完了しました！**

✅ **新規相談受付** - 6段階のフェーズ管理で段階的な対応をサポート  
✅ **相談履歴** - 検索・フィルター・詳細表示で過去の記録を簡単管理  
✅ **統計情報** - 視覚的なグラフで相談傾向を一目で把握  
✅ **対応マニュアル** - カテゴリ別・フェーズ別のフレーズ集で対応を支援  

**田中秀泰代表理事の想い「人は必ずやり直せる」を実現するための、強力なツールが完成しました。**

---
